<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gi√°m s√°t h·ªá th·ªëng</title>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
h2 { text-align: center; margin-top: 20px; }

/* Lu√¥n 2 c·ªôt (PC & mobile ƒë·ªÅu 2 c·ªôt √ó 3 h√†ng) */
.dashboard { 
    display: grid;
    grid-template-columns: repeat(2, 1fr); 
    gap: 15px; 
    margin: 20px auto; 
    max-width: 600px; 
    width: 100%; 
    padding: 0 10px; 
}

.cell { 
    border: 1px solid #ccc; 
    padding: 15px; 
    height: 100px; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    cursor: pointer; 
    background: #f7f7f7; 
    border-radius: 15px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    font-size: 0.9em;
}
.cell:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.cell h3 { margin: 5px 0; font-size: 1em; }
.cell p { font-size: 1.2em; margin: 0; }

/* Modal chart */
#chartModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
#chartModal.show { display: flex; }
#chartContent {
    background: #fff;
    padding: 20px;
    width: 95%;
    max-width: 1000px;
    height: 80vh;
    position: relative;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
}
#closeChart {
    position: absolute;
    top: 10px; right: 10px;
    cursor: pointer;
    font-size: 24px;
    font-weight: bold;
}
#chartContainer { flex: 1; width: 100%; margin-top: 10px; }
.controls { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
.controls label { margin-right: 5px; }

.cell:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    filter: brightness(1.05);
}

</style>
</head>
<body>

<h2>Gi√°m s√°t h·ªá th·ªëng</h2>
<div class="dashboard" id="dashboard"></div>

<div id="chartModal">
    <div id="chartContent">
        <span id="closeChart">‚úñ</span>
        <div class="controls">
            <label><input type="radio" name="mode" value="realtime" checked> Realtime</label>
            <label><input type="radio" name="mode" value="history"> History</label>
            <label for="timeRange">Show last:</label>
            <select id="timeRange">
                <option value="60">1 min</option>
                <option value="300">5 min</option>
                <option value="900">15 min</option>
                <option value="1800" selected>30 min</option>
                <option value="3600">1 hour</option>
            </select>
            <button id="exportChart">Export to Excel</button>
        </div>
        <div id="chartContainer"></div>
    </div>
</div>

<script>
// T√™n sensor
const sensorNames = [
    "OXY B·ªíN 1",
    "OXY B·ªíN 2",
    "OXY",
    "KH√ç N√âN - AIR4",
    "KH√ç H√öT - VAC",
    "KH√ç N√âN - AIR7"
];
const sensorUnits = [
    "%",    // oxy b·ªìn 1
    "%",    // oxy b·ªìn 2
    "BAR",  // OXY
    "BAR",  // kh√≠ n√©n - air4
    "mmHg", // kh√≠ h√∫t-VAC
    "BAR"   // kh√≠ n√©n - air7
];

const eraWidget = new EraWidget();
const sensorCount = sensorNames.length;
const sensorConfigs = [];
const sensorValues = Array(sensorCount).fill(0);
const sensorBuffers = Array.from({length: sensorCount}, () => []);

const dashboard = document.getElementById('dashboard');
for (let i = 0; i < sensorCount; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.id = 'sensorCell' + i;
    cell.innerHTML = `<h3>${sensorNames[i]}</h3><p>0</p>`;
    dashboard.appendChild(cell);
    cell.addEventListener('click', () => openChart(i));
}

for (let i = 0; i < sensorCount; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.id = 'sensorCell' + i;
    cell.innerHTML = `<h3>${sensorNames[i]}</h3><p>0</p>`;

    // üîπ G√°n m√†u n·ªÅn theo t√™n sensor
    const name = sensorNames[i].toUpperCase();
    if (name.includes("B·ªíN 1")) {
        cell.style.backgroundColor = "white"; // B·ªíN OXY 1
    } else if (name.includes("B·ªíN 2")) {
        cell.style.backgroundColor = "white"; // B·ªíN OXY 2
    } else if (name === "OXY") {
        cell.style.backgroundColor = "#00FF00"; // Xanh l√°
    } else if (name.includes("VAC")) {
        cell.style.backgroundColor = "#FFD700"; // V√†ng
    } else if (name.includes("AIR4") || name.includes("AIR7")) {
        cell.style.backgroundColor = "#000000"; // ƒêen
        cell.style.color = "white"; // Ch·ªØ tr·∫Øng cho d·ªÖ ƒë·ªçc
    }

    dashboard.appendChild(cell);
    cell.addEventListener('click', () => openChart(i));
}

eraWidget.init({
    mobileHeight: 500, // Thi·∫øt l·∫≠p chi·ªÅu cao hi·ªÉn th·ªã tr√™n mobile app E-Ra (m·∫∑c ƒë·ªãnh 300px)

    // H√†m callback ƒë∆∞·ª£c g·ªçi khi c√≥ c·∫•u h√¨nh ƒë∆∞·ª£c nh·∫≠n t·ª´ server
    onConfiguration: (config) => {
        config.realtime_configs.slice(0, sensorCount).forEach((cfg, idx) => {
            sensorConfigs[idx] = cfg;
        });
    },

    // H√†m callback ƒë∆∞·ª£c g·ªçi khi nh·∫≠n gi√° tr·ªã m·ªõi t·ª´ server
    onValues: (values) => {
        sensorConfigs.forEach((cfg, idx) => {
            if (!cfg) return;
            const val = values[cfg.id]?.value ?? 0;
            sensorValues[idx] = val;

            // C·∫≠p nh·∫≠t UI
            const cell = document.getElementById('sensorCell'+idx);
            cell.querySelector('p').innerText = `${val.toFixed(2)} ${sensorUnits[idx]}`;


            // L∆∞u d·ªØ li·ªáu v√†o buffer ƒë·ªÉ hi·ªÉn th·ªã chart l·ªãch s·ª≠
            const t = (new Date()).getTime();
            sensorBuffers[idx].push([t, val]);
            const maxBuffer = 3600*1000;
            while (sensorBuffers[idx].length && sensorBuffers[idx][0][0] < t - maxBuffer) {
                sensorBuffers[idx].shift();
            }
        });
    }
});

// eraWidget.onConfiguration(config => {
//     config.realtime_configs.slice(0, sensorCount).forEach((cfg, idx) => {
//         sensorConfigs[idx] = cfg;
//     });
// });

// eraWidget.onValues(values => {
//     sensorConfigs.forEach((cfg, idx) => {
//         if (!cfg) return;
//         const val = values[cfg.id]?.value ?? 0;
//         sensorValues[idx] = val;
//         const cell = document.getElementById('sensorCell'+idx);
//         cell.querySelector('p').innerText = val.toFixed(2);

//         const t = (new Date()).getTime();
//         sensorBuffers[idx].push([t, val]);
//         const maxBuffer = 3600*1000;
//         while (sensorBuffers[idx].length && sensorBuffers[idx][0][0] < t - maxBuffer) {
//             sensorBuffers[idx].shift();
//         }
//     });
// });

// eraWidget.ready();





// Modal chart
let chartInstance = null;
let currentSensor = 0;
let chartInterval = null;
const modal = document.getElementById('chartModal');
const chartContainer = document.getElementById('chartContainer');

document.getElementById('closeChart').addEventListener('click', () => {
    modal.classList.remove('show');
    clearInterval(chartInterval);
});

function openChart(sensorIndex) {
    currentSensor = sensorIndex;
    modal.classList.add('show');
    renderChart();
}

const radios = document.querySelectorAll('input[name="mode"]');
radios.forEach(r => r.addEventListener('change', renderChart));
document.getElementById('timeRange').addEventListener('change', renderChart);

function renderChart() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const rangeSec = parseInt(document.getElementById('timeRange').value);
    const now = (new Date()).getTime();

    if (chartInstance) chartInstance.destroy();
    clearInterval(chartInterval);

    // Thi·∫øt l·∫≠p m√∫i gi·ªù VN (GMT+7)
    Highcharts.setOptions({
        time: {
            timezoneOffset: -7 * 60
        }
    });

    if (mode === 'realtime') {
        chartInstance = Highcharts.chart(chartContainer, {
            chart: { type: 'areaspline' },
            title: { text: `${sensorNames[currentSensor]} Realtime` },
            xAxis: { type: 'datetime' },
            yAxis: { title: { text: 'Value' } },
            tooltip: { xDateFormat: '%Y-%m-%d %H:%M:%S', pointFormat: '{point.y:.2f}' },
            series: [{ name: 'Value', data: [] , lineWidth: 2, fillOpacity: 0.3 }]
        });

        chartInterval = setInterval(() => {
            const x = (new Date()).getTime();
            const y = sensorValues[currentSensor];
            chartInstance.series[0].addPoint([x, y], true, chartInstance.series[0].data.length>1800);
        }, 1000);
    } else {
        const data = sensorBuffers[currentSensor].filter(p => p[0] >= now - rangeSec*1000);
        chartInstance = Highcharts.chart(chartContainer, {
            chart: { type: 'areaspline' },
            title: { text: `${sensorNames[currentSensor]} History` },
            xAxis: { type: 'datetime' },
            yAxis: { title: { text: 'Value' } },
            tooltip: { xDateFormat: '%Y-%m-%d %H:%M:%S', pointFormat: '{point.y:.2f}' },
            series: [{ name: 'Value', data, lineWidth: 2, fillOpacity: 0.3 }]
        });
    }
}

// Export d·ªØ li·ªáu chart
document.getElementById('exportChart').addEventListener('click', () => {
    const ws = XLSX.utils.json_to_sheet(sensorBuffers[currentSensor].map(p => ({
        Time: (new Date(p[0])).toLocaleString("vi-VN"),
        Value: p[1]
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, `${sensorNames[currentSensor]}`);
    XLSX.writeFile(wb, `${sensorNames[currentSensor]}_data.xlsx`);
});
</script>

</body>
</html>
