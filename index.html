<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Giám sát hệ thống</title>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
h2 { text-align: center; margin-top: 20px; }

/* Luôn 2 cột (PC & mobile đều 2 cột × 3 hàng) */
.dashboard { 
    display: grid;
    grid-template-columns: repeat(2, 1fr); 
    gap: 15px; 
    margin: 20px auto; 
    max-width: 600px; 
    width: 100%; 
    padding: 0 10px; 
}

.cell { 
    border: 1px solid #ccc; 
    padding: 15px; 
    height: 100px; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    cursor: pointer; 
    background: #f7f7f7; 
    border-radius: 15px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    font-size: 0.9em;
}
.cell:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.cell h3 { margin: 5px 0; font-size: 1em; }
.cell p { font-size: 1.2em; margin: 0; }

/* Modal chart */
#chartModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
#chartModal.show { display: flex; }
#chartContent {
    background: #fff;
    padding: 20px;
    width: 95%;
    max-width: 1000px;
    height: 80vh;
    position: relative;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
}
#closeChart {
    position: absolute;
    top: 10px; right: 10px;
    cursor: pointer;
    font-size: 24px;
    font-weight: bold;
}
#chartContainer { flex: 1; width: 100%; margin-top: 10px; }
.controls { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
.controls label { margin-right: 5px; }

.cell:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    filter: brightness(1.05);
}

</style>
</head>
<body>

<h2>Giám sát hệ thống</h2>
<div class="dashboard" id="dashboard"></div>

<div id="chartModal">
    <div id="chartContent">
        <span id="closeChart">✖</span>
        <div class="controls">
            <label for="startTime">Từ:</label>
            <input type="datetime-local" id="startTime">

            <label for="endTime">Đến:</label>
            <input type="datetime-local" id="endTime">

            <button id="loadHistory">Xem Lịch Sử</button>
            <button id="exportChart">Export to Excel</button>
        </div>
        <div id="chartContainer"></div>
    </div>
</div>

<script>
// Tên sensor
const sensorNames = [
    "OXY BỒN 1", "OXY BỒN 2", "OXY",
    "KHÍ NÉN - AIR4", "KHÍ HÚT - VAC", "KHÍ NÉN - AIR7"
];
const sensorUnits = ["%", "%", "BAR", "BAR", "mmHg", "BAR"];

const eraWidget = new EraWidget();
const sensorCount = sensorNames.length;
const sensorConfigs = [];
const sensorValues = Array(sensorCount).fill(0);

// Không cần sensorBuffers nữa vì ta sẽ gọi API để lấy lịch sử
// const sensorBuffers = Array.from({length: sensorCount}, () => []);

const dashboard = document.getElementById('dashboard');
for (let i = 0; i < sensorCount; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.id = 'sensorCell' + i;
    cell.innerHTML = `<h3>${sensorNames[i]}</h3><p>0 ${sensorUnits[i]}</p>`;

    const name = sensorNames[i].toUpperCase();
    if (name.includes("BỒN OXY 1")) cell.style.backgroundColor = "white";
    else if (name.includes("BỒN OXY 2")) cell.style.backgroundColor = "white";
    else if (name === "OXY") cell.style.backgroundColor = "#00FF00";
    else if (name.includes("VAC")) cell.style.backgroundColor = "#FFD700";
    else if (name.includes("AIR4") || name.includes("AIR7")) {
        cell.style.backgroundColor = "#000000";
        cell.style.color = "white";
    }

    dashboard.appendChild(cell);
    cell.addEventListener('click', () => openChart(i));
}

eraWidget.init({
    mobileHeight: 500,
    onConfiguration: (config) => {
        config.realtime_configs.slice(0, sensorCount).forEach((cfg, idx) => {
            sensorConfigs[idx] = cfg;
        });
        // Gọi ready() sau khi đã có config để đảm bảo widget hoạt động
        eraWidget.ready();
    },
    onValues: (values) => {
        sensorConfigs.forEach((cfg, idx) => {
            if (!cfg) return;
            const val = values[cfg.id]?.value ?? 0;
            sensorValues[idx] = val;
            const cell = document.getElementById('sensorCell' + idx);
            cell.querySelector('p').innerText = `${val.toFixed(2)} ${sensorUnits[idx]}`;
        });
    }
});

// --- PHẦN BIỂU ĐỒ ĐÃ CẬP NHẬT ---
let chartInstance = null;
let currentSensor = 0;
let chartInterval = null;
const modal = document.getElementById('chartModal');
const chartContainer = document.getElementById('chartContainer');

// Thiết lập múi giờ VN (GMT+7) cho Highcharts
Highcharts.setOptions({
    time: {
        timezoneOffset: -7 * 60
    }
});

// Mở biểu đồ và mặc định chạy chế độ Realtime
function openChart(sensorIndex) {
    currentSensor = sensorIndex;
    modal.classList.add('show');
    
    // Hủy interval cũ nếu có
    if (chartInterval) clearInterval(chartInterval);
    if (chartInstance) chartInstance.destroy();

    // Vẽ biểu đồ realtime
    chartInstance = Highcharts.chart(chartContainer, {
        chart: { type: 'areaspline' },
        title: { text: `${sensorNames[currentSensor]} - Realtime` },
        xAxis: { type: 'datetime' },
        yAxis: { title: { text: `Value (${sensorUnits[currentSensor]})` } },
        tooltip: { xDateFormat: '%Y-%m-%d %H:%M:%S', pointFormat: `{point.y:.2f} ${sensorUnits[currentSensor]}` },
        series: [{ name: 'Value', data: [], lineWidth: 2, fillOpacity: 0.3 }]
    });

    // Bắt đầu cập nhật realtime
    chartInterval = setInterval(() => {
        if (chartInstance && chartInstance.series) { // Kiểm tra chart còn tồn tại
            const x = (new Date()).getTime();
            const y = sensorValues[currentSensor];
            chartInstance.series[0].addPoint([x, y], true, chartInstance.series[0].data.length > 300);
        }
    }, 1000);
}

// Đóng biểu đồ
document.getElementById('closeChart').addEventListener('click', () => {
    modal.classList.remove('show');
    // Dừng cập nhật realtime khi đóng
    if (chartInterval) clearInterval(chartInterval);
});

// Xử lý sự kiện bấm nút "Xem Lịch Sử"
document.getElementById('loadHistory').addEventListener('click', async () => {
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;

    if (!startTime || !endTime) {
        alert("Vui lòng chọn cả thời gian bắt đầu và kết thúc.");
        return;
    }

    // Chuyển đổi sang timestamp (milliseconds)
    const from = new Date(startTime).getTime();
    const to = new Date(endTime).getTime();

    if (from >= to) {
        alert("Thời gian bắt đầu phải trước thời gian kết thúc.");
        return;
    }

    // Dừng chế độ realtime
    if (chartInterval) clearInterval(chartInterval);
    
    // Hiển thị trạng thái đang tải
    chartInstance.showLoading('Đang tải dữ liệu lịch sử...');

    try {
        // Lấy config ID của sensor hiện tại
        const configId = sensorConfigs[currentSensor].id;

        // Gọi API để lấy dữ liệu lịch sử
        const historyData = await eraWidget.getHistory({
            id: configId,
            from: from,
            to: to,
        });

        // Xử lý và vẽ lại biểu đồ với dữ liệu lịch sử
        // Dữ liệu trả về có dạng { ts: timestamp, val: value }
        const formattedData = historyData.map(point => [point.ts, point.val]);

        chartInstance.hideLoading(); // Ẩn trạng thái tải
        chartInstance.update({
            title: { text: `${sensorNames[currentSensor]} - Lịch sử` },
            series: [{
                name: 'History Value',
                data: formattedData
            }]
        });

    } catch (error) {
        chartInstance.hideLoading();
        alert("Không thể tải dữ liệu lịch sử. Vui lòng thử lại.");
        console.error("Lỗi khi lấy dữ liệu lịch sử:", error);
    }
});

// Chức năng Export (Cần điều chỉnh để export đúng dữ liệu đang hiển thị)
document.getElementById('exportChart').addEventListener('click', () => {
    if (!chartInstance || !chartInstance.series[0]) {
        alert("Chưa có dữ liệu để export.");
        return;
    }

    // Lấy dữ liệu trực tiếp từ series của biểu đồ
    const dataToExport = chartInstance.series[0].data.map(point => ({
        Time: new Date(point.x).toLocaleString("vi-VN", { timeZone: 'Asia/Ho_Chi_Minh' }),
        Value: point.y
    }));

    if (dataToExport.length === 0) {
        alert("Không có dữ liệu trên biểu đồ để export.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, `${sensorNames[currentSensor]}`);
    XLSX.writeFile(wb, `${sensorNames[currentSensor]}_data.xlsx`);
});
</script>

</body>
</html>
