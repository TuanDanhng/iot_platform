<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Multi-Sensor Dashboard</title>

<!-- Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<!-- ERA Widget -->
<script src="https://www.unpkg.com/@eohjsc/era-widget@1.0.14/src/index.js"></script>

<!-- XLSX export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<style>
body { font-family: Arial, sans-serif; }
h2 { text-align: center; margin-top: 20px; }

.dashboard { 
    display: flex; 
    flex-direction: column; /* xếp dọc */
    gap: 15px; 
    margin: 20px auto; 
    width: 200px; /* độ rộng ô */
}
.cell { 
    border: 1px solid #ccc; 
    padding: 15px; 
    height: 100px; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    cursor: pointer; 
    background: #f7f7f7; 
    border-radius: 15px; /* bo tròn ô */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}
.cell:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.cell h3 { margin: 5px 0; }
.cell p { font-size: 1.2em; margin: 0; }

/* Modal overlay */
#chartModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
#chartModal.show {
    display: flex;
}
#chartContent {
    background: #fff;
    padding: 20px;
    width: 90%;
    max-width: 1000px;
    height: 500px;
    position: relative;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
}
#closeChart {
    position: absolute;
    top: 10px; right: 10px;
    cursor: pointer;
    font-size: 24px;
    font-weight: bold;
}
#chartContainer { flex: 1; width: 100%; }
#timeRange, #exportChart { margin-top: 10px; align-self: flex-start; }
</style>
</head>
<body>

<!-- <h2>Giám sát hệ thống</h2> -->

<div class="dashboard" id="dashboard">
    <!-- Các ô sẽ được tạo tự động bằng JS -->
</div>

<div id="chartModal">
    <div id="chartContent">
        <span id="closeChart">✖</span>
        <div id="chartContainer"></div>
        <div>
            <label for="timeRange">Show last: </label>
            <select id="timeRange">
                <option value="60">1 min</option>
                <option value="300">5 min</option>
                <option value="900">15 min</option>
                <option value="1800" selected>30 min</option>
                <option value="3600">1 hour</option>
            </select>
            <button id="exportChart">Export to Excel</button>
        </div>
    </div>
</div>

<script>
// ERA Widget setup
const eraWidget = new EraWidget();
const sensorCount = 6;
const sensorConfigs = [];
const sensorValues = Array(sensorCount).fill(0);
const sensorBuffers = Array.from({length: sensorCount}, () => []);

// Tạo dashboard 6 ô
const dashboard = document.getElementById('dashboard');
for (let i = 0; i < sensorCount; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.id = 'sensorCell' + i;
    cell.innerHTML = `<h3>Sensor ${i+1}</h3><p>0</p>`;
    dashboard.appendChild(cell);
    cell.addEventListener('click', () => openChart(i));
}

// Nhận cấu hình từ ERA Widget
eraWidget.onConfiguration(config => {
    config.realtime_configs.slice(0, sensorCount).forEach((cfg, idx) => {
        sensorConfigs[idx] = cfg;
    });
});

// Nhận dữ liệu realtime
eraWidget.onValues(values => {
    sensorConfigs.forEach((cfg, idx) => {
        if (!cfg) return;
        const val = values[cfg.id]?.value ?? 0;
        sensorValues[idx] = val;
        const cell = document.getElementById('sensorCell'+idx);
        cell.querySelector('p').innerText = val.toFixed(2);

        // Lưu buffer tối đa 1 giờ
        const t = (new Date()).getTime();
        sensorBuffers[idx].push([t, val]);
        const maxBuffer = 3600*1000;
        while (sensorBuffers[idx].length && sensorBuffers[idx][0][0] < t - maxBuffer) {
            sensorBuffers[idx].shift();
        }
    });
});

eraWidget.ready();

// Modal chart
let chartInstance = null;
let currentSensor = 0;
const modal = document.getElementById('chartModal');
const chartContainer = document.getElementById('chartContainer');
document.getElementById('closeChart').addEventListener('click', () => modal.classList.remove('show'));

function openChart(sensorIndex) {
    currentSensor = sensorIndex;
    modal.classList.add('show');
    renderChart();
}

document.getElementById('timeRange').addEventListener('change', renderChart);

function renderChart() {
    const rangeSec = parseInt(document.getElementById('timeRange').value);
    const now = (new Date()).getTime();
    const data = sensorBuffers[currentSensor].filter(p => p[0] >= now - rangeSec*1000);

    if (chartInstance) chartInstance.destroy();

    chartInstance = Highcharts.chart(chartContainer, {
        chart: { type: 'areaspline' },
        title: { text: `Sensor ${currentSensor+1} Data` },
        xAxis: { type: 'datetime' },
        yAxis: { title: { text: 'Value' } },
        tooltip: { xDateFormat: '%Y-%m-%d %H:%M:%S', pointFormat: '{point.y:.2f}' },
        series: [{
            name: 'Value',
            data,
            lineWidth: 2,
            fillOpacity: 0.3
        }]
    });
}

// Export dữ liệu chart
document.getElementById('exportChart').addEventListener('click', () => {
    const ws = XLSX.utils.json_to_sheet(sensorBuffers[currentSensor].map(p => ({
        Time: (new Date(p[0])).toLocaleString(),
        Value: p[1]
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, `Sensor${currentSensor+1}`);
    XLSX.writeFile(wb, `Sensor${currentSensor+1}_data.xlsx`);
});
</script>

</body>
</html>
