<!DOCTYPE html>
<html>
<head>
  <title>Đọc dữ liệu từ ERA</title>
</head>
<body>
  <h1>Giá trị RS485 (Datastream V)</h1>
  <div id="valueBox">Đang tải...</div>

  <script src="https://widget.era.vn/sdk/era-widget.js"></script>
  <script>
    const eraWidget = new EraWidget();
    let sensorData = {}; // lưu giá trị mới nhất

    // Khi load cấu hình từ ERA (gateway + device + datastream)
    eraWidget.onConfiguration((configuration) => {
      console.log("Cấu hình:", configuration);

      // duyệt qua datastream
      configuration.realtime_configs.forEach(cfg => {
        console.log("Tìm thấy:", cfg);

        // nếu là datastream V từ device ESP32_PLC
        if (cfg.device_name === "ESP32_PLC" && cfg.datastream_name === "V") {
          sensorData[cfg.name] = null; // khởi tạo
        }
      });
    });

    // Lắng nghe dữ liệu realtime
    eraWidget.onRealtime((msg) => {
      if (msg.name) {
        sensorData[msg.name] = msg.value;
        console.log("Có dữ liệu:", msg);

        // Hiển thị lên web
        document.getElementById("valueBox").innerText =
          `Datastream ${msg.name} = ${msg.value}`;
      }
    });
  </script>
</body>
</html>
